{% extends "base.html" %}

{% block title %}Voice Cloning - EPUB to Audiobook{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-microphone me-2"></i>
            Voice Cloning
        </h2>
        <p class="text-muted mb-4">
            Create custom voice clones from audio samples. Upload 10-30 seconds of clear speech 
            to generate a new voice for your audiobooks.
        </p>
    </div>
</div>

<div class="row">
    <!-- Voice Creation -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Create New Voice Clone
                </h5>
            </div>
            <div class="card-body">
                <form id="voice-clone-form" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="voice-name" class="form-label">Voice Name</label>
                                <input type="text" class="form-control" id="voice-name" name="voice_name" 
                                       placeholder="e.g., John's Voice" required>
                                <div class="form-text">Give your voice clone a unique name</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="voice-language" class="form-label">Language</label>
                                <select class="form-select" id="voice-language" name="language">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="voice-gender" class="form-label">Gender</label>
                                <select class="form-select" id="voice-gender" name="gender">
                                    <option value="neutral">Neutral</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="audio-sample" class="form-label">Audio Sample</label>
                                <input type="file" class="form-control" id="audio-sample" name="audio" 
                                       accept="audio/*" required>
                                <div class="form-text">
                                    Upload WAV, MP3, or M4A file (10-30 seconds recommended)
                                </div>
                            </div>
                            
                            <!-- Audio Preview -->
                            <div id="audio-preview" class="d-none mb-3">
                                <label class="form-label">Preview</label>
                                <audio controls class="w-100" id="audio-player">
                                    Your browser does not support the audio element.
                                </audio>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        Duration: <span id="audio-duration">--:--</span>
                                        • Size: <span id="audio-size">-- MB</span>
                                    </small>
                                </div>
                            </div>
                            
                            <div class="alert alert-info">
                                <h6><i class="fas fa-lightbulb me-2"></i>Tips for Best Results</h6>
                                <ul class="mb-0 small">
                                    <li>Use clear, high-quality audio</li>
                                    <li>Minimize background noise</li>
                                    <li>10-30 seconds of natural speech</li>
                                    <li>Consistent volume and pace</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#advanced-options">
                            <i class="fas fa-cog me-2"></i>Advanced Options
                        </button>
                        
                        <div class="collapse mt-3" id="advanced-options">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="voice-style" class="form-label">Voice Style</label>
                                    <select class="form-select form-select-sm" id="voice-style">
                                        <option value="neutral">Neutral</option>
                                        <option value="calm">Calm</option>
                                        <option value="energetic">Energetic</option>
                                        <option value="formal">Formal</option>
                                        <option value="casual">Casual</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="voice-age" class="form-label">Apparent Age</label>
                                    <select class="form-select form-select-sm" id="voice-age">
                                        <option value="young">Young (18-30)</option>
                                        <option value="adult" selected>Adult (30-50)</option>
                                        <option value="mature">Mature (50+)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" id="create-voice-btn">
                            <i class="fas fa-magic me-2"></i>
                            Create Voice Clone
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Progress Card -->
        <div class="card mt-4 d-none" id="cloning-progress">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Voice Cloning Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="progress-circle mx-auto mb-3" style="--progress: 0%">
                            <div class="progress-text">0%</div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <h6 id="cloning-step">Analyzing audio sample...</h6>
                        <p class="text-muted mb-2" id="cloning-description">
                            Processing your audio to extract voice characteristics
                        </p>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="cloning-progress-bar">
                                0%
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            Estimated time: <span id="cloning-eta">3-5 minutes</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Existing Voices -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Your Voice Clones
                </h5>
            </div>
            <div class="card-body">
                <div id="voice-list">
                    <!-- Sample voices for demo -->
                    <div class="card mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Sample Voice 1</h6>
                                    <small class="text-muted">English • Female • Created 2 days ago</small>
                                    <div class="mt-2">
                                        <span class="badge bg-success">Ready</span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-play me-2"></i>Test</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">Sample Voice 2</h6>
                                    <small class="text-muted">English • Male • Created 1 week ago</small>
                                    <div class="mt-2">
                                        <span class="badge bg-warning">Processing</span>
                                    </div>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item disabled" href="#"><i class="fas fa-play me-2"></i>Test</a></li>
                                        <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-microphone-alt fa-2x mb-2 d-block"></i>
                        <small>Create your first voice clone above</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Voice Testing -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-vial me-2"></i>
                    Test Voice
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="test-voice" class="form-label">Select Voice</label>
                    <select class="form-select form-select-sm" id="test-voice">
                        <option value="">Choose a voice...</option>
                        <option value="sample1">Sample Voice 1</option>
                        <option value="default_female">Default Female</option>
                        <option value="default_male">Default Male</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="test-text" class="form-label">Test Text</label>
                    <textarea class="form-control form-control-sm" id="test-text" rows="3" 
                              placeholder="Enter text to synthesize...">Hello, this is a test of the voice cloning system. How does it sound?</textarea>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" onclick="testVoice()">
                        <i class="fas fa-play me-2"></i>
                        Generate Test Audio
                    </button>
                </div>
                
                <div id="test-result" class="d-none mt-3">
                    <audio controls class="w-100">
                        <source src="" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentCloningJob = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Audio file handler
        document.getElementById('audio-sample').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                previewAudio(file);
            }
        });
        
        // Form submission
        document.getElementById('voice-clone-form').addEventListener('submit', function(e) {
            e.preventDefault();
            startVoiceCloning();
        });
    });
    
    function previewAudio(file) {
        const preview = document.getElementById('audio-preview');
        const player = document.getElementById('audio-player');
        const duration = document.getElementById('audio-duration');
        const size = document.getElementById('audio-size');
        
        // Create URL for audio file
        const url = URL.createObjectURL(file);
        player.src = url;
        
        // Show preview
        preview.classList.remove('d-none');
        
        // Update file info
        const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
        size.textContent = sizeInMB + ' MB';
        
        // Get duration when metadata loads
        player.addEventListener('loadedmetadata', function() {
            const minutes = Math.floor(player.duration / 60);
            const seconds = Math.floor(player.duration % 60);
            duration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Validate duration
            if (player.duration < 5 || player.duration > 60) {
                showAlert('Audio should be between 5-60 seconds for best results', 'warning');
            }
        });
    }
    
    function startVoiceCloning() {
        const formData = new FormData(document.getElementById('voice-clone-form'));
        
        // Validate form
        const voiceName = formData.get('voice_name');
        const audioFile = formData.get('audio');
        
        if (!voiceName || !audioFile) {
            showAlert('Please provide a voice name and audio file', 'danger');
            return;
        }
        
        // Show progress
        document.getElementById('cloning-progress').classList.remove('d-none');
        document.getElementById('create-voice-btn').disabled = true;
        
        // Start cloning process
        fetch('/api/voice-clone', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.job_id) {
                currentCloningJob = data.job_id;
                pollCloningProgress();
            } else {
                throw new Error(data.error || 'Failed to start voice cloning');
            }
        })
        .catch(error => {
            showAlert('Error starting voice cloning: ' + error.message, 'danger');
            resetCloningUI();
        });
    }
    
    function pollCloningProgress() {
        const steps = [
            'Analyzing audio sample...',
            'Extracting voice features...',
            'Training voice model...',
            'Optimizing parameters...',
            'Finalizing voice clone...'
        ];
        
        let stepIndex = 0;
        let progress = 0;
        
        const poll = setInterval(() => {
            // Simulate progress
            progress += Math.random() * 15;
            if (progress > 100) progress = 100;
            
            // Update step
            if (progress > stepIndex * 20 && stepIndex < steps.length - 1) {
                stepIndex++;
                document.getElementById('cloning-step').textContent = steps[stepIndex];
            }
            
            // Update UI
            updateProgress(document.querySelector('.progress-circle'), progress);
            
            const progressBar = document.getElementById('cloning-progress-bar');
            progressBar.style.width = progress + '%';
            progressBar.textContent = Math.round(progress) + '%';
            
            // Complete
            if (progress >= 100) {
                clearInterval(poll);
                completeCloningProcess();
            }
        }, 800);
    }
    
    function completeCloningProcess() {
        document.getElementById('cloning-step').textContent = 'Voice clone created successfully!';
        document.getElementById('cloning-description').textContent = 'Your new voice is ready to use';
        
        setTimeout(() => {
            showAlert('Voice clone created successfully!', 'success');
            resetCloningUI();
            
            // Add to voice list (in real implementation, this would refresh from server)
            addVoiceToList(document.getElementById('voice-name').value);
            
            // Reset form
            document.getElementById('voice-clone-form').reset();
            document.getElementById('audio-preview').classList.add('d-none');
        }, 2000);
    }
    
    function resetCloningUI() {
        document.getElementById('cloning-progress').classList.add('d-none');
        document.getElementById('create-voice-btn').disabled = false;
        currentCloningJob = null;
    }
    
    function addVoiceToList(voiceName) {
        const voiceList = document.getElementById('voice-list');
        const emptyMessage = voiceList.querySelector('.text-center.text-muted');
        
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const voiceCard = document.createElement('div');
        voiceCard.className = 'card mb-3';
        voiceCard.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${voiceName}</h6>
                        <small class="text-muted">English • Custom • Just created</small>
                        <div class="mt-2">
                            <span class="badge bg-success">Ready</span>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" 
                                data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-play me-2"></i>Test</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-trash me-2"></i>Delete</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
        
        voiceList.insertBefore(voiceCard, voiceList.firstChild);
        
        // Add to test dropdown
        const testSelect = document.getElementById('test-voice');
        const option = document.createElement('option');
        option.value = voiceName.toLowerCase().replace(/\s+/g, '_');
        option.textContent = voiceName;
        testSelect.appendChild(option);
    }
    
    function testVoice() {
        const voice = document.getElementById('test-voice').value;
        const text = document.getElementById('test-text').value;
        
        if (!voice || !text) {
            showAlert('Please select a voice and enter test text', 'warning');
            return;
        }
        
        // In a real implementation, this would generate test audio
        showAlert('Test audio would be generated here (not implemented in demo)', 'info');
        
        // Show test result placeholder
        document.getElementById('test-result').classList.remove('d-none');
    }
</script>
{% endblock %}